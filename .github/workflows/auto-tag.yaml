name: Auto Version Tag

on:
  push:
    branches: [main]
    paths:
      - 'plan/*.yaml'
  workflow_dispatch:
    inputs:
      force_create:
        description: 'Force create tag even if exists'
        required: false
        default: 'false'
        type: choice
        options: ['true', 'false']

jobs:
  tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate and push version tag
        env:
          FORCE: ${{ github.event.inputs.force_create }}
        run: |
          set -e
          # åªå¤„ç† x.y.z.yaml æ–‡ä»¶
          versions=$(ls plan/*.yaml | grep -E 'plan/[0-9]+\.[0-9]+\.[0-9]+\.yaml' || true)
          if [ -z "$versions" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç‰ˆæœ¬ yaml æ–‡ä»¶"
            exit 1
          fi

          # æå–ç‰ˆæœ¬å·ï¼Œå¹¶è¿›è¡Œæ’åºæ‰¾å‡ºæœ€å¤§ç‰ˆæœ¬
          max=$(printf "%s\n" $versions \
            | sed -E 's|.*/([0-9]+\.[0-9]+\.[0-9]+)\.yaml$|\1|' \
            | sort -V \
            | tail -n1)

          tag="v$max"
          echo "âš™ï¸ ä½¿ç”¨ tag: $tag"

          # å·²å­˜åœ¨ tag?
          if git rev-parse --verify "$tag" >/dev/null 2>&1; then
            if [ "$FORCE" = "true" ]; then
              echo "â™»ï¸ tag å­˜åœ¨ä½† force=trueï¼Œå°†é‡æ–°åˆ›å»º"
              git tag -d "$tag"
              git push origin ":refs/tags/$tag"
            else
              echo "âœ… tag å·²å­˜åœ¨ï¼Œä¸”æ²¡æœ‰å¯ç”¨ forceï¼Œè·³è¿‡ã€‚"
              exit 0
            fi
          fi

          # åˆ›å»ºå¹¶æ¨é€ tag
          git tag "$tag"
          git push origin "$tag"
          echo "ğŸ‰ Tag åˆ›å»ºå¹¶æ¨é€å®Œæ¯•ï¼"